---
title: "Stat 400 Project"
authors: "Nathan Hemenway, Mark Hinds, Ian Hall"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#testing github
library(tidyverse)

#create starting positions and state function
starting_vals <- function(num_subjects, I_0, x_dim, y_dim){
  
  #Infect I_0 many starting subjects
  subjects <- rep('S', num_subjects)
  infect <- sample(x = 1:num_subjects, size=I_0, replace=FALSE)
  subjects[infect] <- 'I'
  
  #Storage for x, y starting positions for the subjects
  start_x <- runif(n=num_subjects, min=0, max=x_dim)
  start_y <- runif(n=num_subjects, min=0, max=y_dim)
  
  #Put into a data frame
  df <- as.data.frame(cbind(as.numeric(start_x), as.numeric(start_y), subjects))
  colnames(df)[1] <- 'x'
  colnames(df)[2] <- 'y'
  return(df)
}

#Random step length function
get_step_length <- function(df, x_dim, y_dim){
  step_lengths <- rnorm(n=nrow(df), mean=min(x_dim, y_dim)/4, sd=min(x_dim, y_dim)/12)
  return(step_lengths)
}

#Random step direction function
get_step_direction <- function(length_vec){
  direction <- runif(n=length(length_vec), min=0, max=2*pi)
}

#Get delta_x, delta_y
get_delts <- function(length_vec, direc_vec){
  delta_x <- length_vec * cos(direc_vec)
  delta_y <- length_vec * sin(direc_vec)
  return(cbind(delta_x, delta_y))
}

#Function for getting updated coordinates
update_coords <- function(og_df, delta_df){
  new_mx <- matrix(data=NA, nrow=nrow(og_df), ncol=3)
  new_df <- data.frame(new_mx)
  new_df[,1] <- as.numeric(og_df[,'x']) + delta_df[,'delta_x']
  new_df[,2] <- as.numeric(og_df[,'y']) + delta_df[,'delta_y']
  new_df[,3] <- og_df[,3]
  colnames(new_df) <- c('x', 'y', 'subjects')
  
  new_df
}

coord_checker <- function(og_df, new_df, x_dim, y_dim){
  baddies <- NULL
  for(i in 1:nrow(new_df)){
    if(as.numeric(new_df[i, 'x']) > x_dim | as.numeric(new_df[i, 'x']) < 0 | as.numeric(new_df[i, 'y']) > y_dim | as.numeric(new_df[i, 'y']) < 0){
      baddies <- append(baddies, i)
    }
  }
  
  if(is.null(baddies)){
    return(new_df)
  }else{
  new_step <- get_step_length(new_df[i,], x_dim, y_dim)
  new_direction <- get_step_direction(new_step)
  new_change <- get_delts(new_step, new_direction)
  new_df <- update_coords(og_df[baddies,], new_change)
  full_df <- rbind(new_df, og_df[-baddies,])
  return(coord_checker(og_df, full_df, x_dim, y_dim))
  }
}

#Function for deciding if infections occured
#BUG -- If the mean_crit_dist is small, all infections go away!!
#BUG -- Sometimes d is NA, I assume it's when indv goes off map. 
infection_status <- function(state, mean_crit_dist){
  
  current_infected <- state[state[,3]=='I',]
  current_suceptable <- state[state[,3]=='S',]
  current_removed <- state[state[,3]=='R',]
  current_non_infected <- rbind(current_suceptable, current_removed)
  
  #store new infection status
  new_status <- rep(NA, nrow(current_non_infected))
  newly_infected <- NULL
  
  #Check to see which susceptible subjects get infected
  #For loop
  
  for(i in 1:nrow(current_infected)){
    for(j in 1:nrow(current_non_infected)){
      x_i <- as.numeric(current_infected[i, 'x'])
      y_i <- as.numeric(current_infected[i, 'y'])
      x_s <- as.numeric(current_suceptable[j, 'x'])
      y_s <- as.numeric(current_suceptable[j, 'y'])
      crucial_distance <- rexp(1, 1/mean_crit_dist)
      d <- sqrt((x_i - x_s)^2 + (y_i - y_s)^2)
    
      
      if(d <= crucial_distance){
        new_status[j] <- 'I'
        newly_infected <- c(newly_infected, j)
      }
      else{
        new_status[j] <- 'S'
      }
    }
  }
  
  current_non_infected[newly_infected, 3] <- 'I'
  new_state <- rbind(current_infected, current_non_infected)
  
  # new_state <- c(new_status, current_infected[,3])
  return(new_state)
}
  


#simulation function
simulator <- function(days, num_subjects, x_dim, y_dim, I_0){
  initial_data <- starting_vals(num_subjects = num_subjects, x_dim=x_dim, y_dim=y_dim, I_0=I_0)
  end_day <- list()
  
  recovery_time <- c()
  
  for(i in 1:days){
    
    if(i == 1){
      step_size <- get_step_length(initial_data, x_dim, y_dim)
      direction <- get_step_direction(step_size)
      change <- get_delts(step_size, direction)
  
      updated_positions <- update_coords(initial_data, change)
      checked_positions <- coord_checker(og_df=initial_data, new_df=updated_positions, x_dim=x_dim, y_dim=y_dim)
      new_status <- infection_status(checked_positions, 2)
      checked_positions[,3] <- new_status
      end_day[[i]] <- checked_positions
      
      updated_positions <- update_coords(initial_data, change)#, x_dim, y_dim)x_dim,y_dim not parameters
      # checked_positions <- coord_checker(og_df=initial_data, new_df=updated_positions, x_dim=x_dim, y_dim=y_dim)
      updated_state <- cbind(updated_positions, initial_data[,3])
      
      new_status <- infection_status(updated_state, 2)
      
      end_day[[i]] <- cbind(updated_positions, new_status)
    }
    else{
      step_size <- get_step_length(initial_data, x_dim, y_dim)
      direction <- get_step_direction(step_size)
      change <- get_delts(step_size, direction)
  
      updated_positions <- update_coords(end_day[[i-1]], change)
      checked_positions <- coord_checker(og_df=end_day[[i-1]], new_df=updated_positions, x_dim=x_dim, y_dim=y_dim)
      new_status <- infection_status(checked_positions, 1/5)
      checked_positions[,3] <- new_status
      end_day[[i]] <- checked_positions
  
      updated_positions <- update_coords(end_day[[i-1]], change)#, x_dim, y_dim) #x_dim,y_dim not parameters in update_coords
      updated_state <- cbind(updated_positions, end_day[[i-1]]$new_status)
      
      rand_recovery_time <- rpois(1,14)
      new_status <- infection_status(updated_state, 1/5,i,rand_recovery_time)
      
      end_day[[i]] <- cbind(updated_positions, new_status)
    }
  }
  return(end_day[[3]])
}


#Testing
df <- starting_vals(100, 2, 10, 10)
len <- get_step_length(df, 10, 10)
dir <- get_step_direction(len)
delts <- get_delts(len, dir)
newdf <- update_coords(df, delts)
coords <- coord_checker(df, newdf, 10, 10)
coords
new_status <- infection_status(coords, 2)
new_status

x = simulator(100,25,1,1,2)


```

Plots
``` {r}
ggplot() + 
  geom_line(aes())
```

```{r}
#reported monte carlo summary data
qd = c(0,25,50,75)
pos = c(99.3,99.2,98.7,92.7)
dncpv = c(69,53,46,33)
dncpt = c(26,32,43,42)
r0 = c(1.8,1.73,1.8,1.63)
mcsum = cbind(qd,pos,dncpv,dncpt,r0)
colnames(mcsum,c("Quarantine degree [%]",	"Percentage of size %",	"DNC peak value [cases]",	"DNC peaking time [days]",	"R0"))
```

